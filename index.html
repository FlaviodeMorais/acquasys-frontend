<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AcquaSys</title>
  <meta name="description" content="AcquaSys Â· Dashboard de monitoramento" />
  <meta name="theme-color" content="#0078D4" />
  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --bg:#f6f8fb;
      --card:#ffffff;
      --muted:#6b7280;
      --brand:#0078D4;
      --accent:#0ea5e9;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:#0f172a}
    .container{max-width:1200px;margin:28px auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:52px;height:52px;border-radius:8px;background:linear-gradient(135deg,var(--brand),#004a8a);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:20px}
    h1{margin:0;font-size:20px}
    p.subtitle{margin:0;color:var(--muted);font-size:13px}
    .status{display:flex;gap:14px;align-items:center;color:var(--muted);font-size:13px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{background:var(--card);border-radius:10px;padding:16px;box-shadow:0 6px 18px rgba(10,20,40,0.04)}
    .col-4{grid-column:span 4}
    .col-8{grid-column:span 8}
    .col-12{grid-column:span 12}
    .metric-large{font-size:36px;font-weight:700;color:var(--brand)}
    .muted{color:var(--muted);font-size:13px}
    .bar{height:10px;background:#eef2f6;border-radius:999px;overflow:hidden;margin-top:10px}
    .bar-fill{height:100%;background:linear-gradient(90deg,#10b981,#0078D4);width:40%}
    .chip{display:inline-flex;padding:6px 10px;border-radius:999px;font-size:13px}
    .chip.on{background:#ecfeff;color:#0369a1}
    .chip.off{background:#fff7ed;color:#9a3412}
    .small-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
    .alert{padding:10px;border-radius:8px;background:#fff3f2;color:#9b1c1c;border:1px solid #ffd7d2;margin-bottom:6px}
    footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}
    #telegram-events{max-height:160px;overflow-y:auto;white-space:pre-line;font-size:13px;color:#1e293b;background:#f9fafb;padding:10px;border-radius:8px;border:1px solid #e5e7eb}
    @media (max-width:900px){
      .col-4,.col-8{grid-column:span 12}
      .small-grid{grid-template-columns:repeat(1,1fr)}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">A</div>
        <div>
          <h1>AcquaSys</h1>
          <p class="subtitle">Monitoramento IoT Â· NÃ­vel e Controle de Bombas</p>
        </div>
      </div>
      <div class="status" id="status-strip">
        <div>MQTT: <strong id="stat-mqtt" style="color:#ef4444">offline</strong></div>
        <div>InfluxDB: <strong id="stat-influx" style="color:#ef4444">offline</strong></div>
      </div>
    </header>

    <main class="grid">
      <!-- Left column -->
      <section class="card col-4">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="muted">NÃ­vel do ReservatÃ³rio</div>
            <div class="metric-large" id="water-level">--%</div>
            <div class="muted" id="last-update">Ãšltima: â€”</div>
          </div>
          <div style="text-align:right">
            <div class="muted">Bomba</div>
            <div id="pump-chip" class="chip off">DESLIGADA</div>
            <div style="height:12px"></div>
            <div class="muted">Corrente</div>
            <div style="font-weight:600;font-size:18px" id="current">-- A</div>
          </div>
        </div>
        <div class="bar" aria-hidden="true">
          <div class="bar-fill" id="level-bar" style="width:0%"></div>
        </div>
        <div class="small-grid">
          <div class="card" style="padding:12px">
            <div class="muted">Temperatura</div>
            <div style="font-weight:700;font-size:18px" id="temp">-- Â°C</div>
          </div>
          <div class="card" style="padding:12px">
            <div class="muted">VazÃ£o</div>
            <div style="font-weight:700;font-size:18px" id="flow">-- L/m</div>
          </div>
          <div class="card" style="padding:12px">
            <div class="muted">EficiÃªncia</div>
            <div style="font-weight:700;font-size:18px" id="eff">-- %</div>
          </div>
        </div>
      </section>

      <!-- Right column: chart -->
      <section class="card col-8">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><div style="font-weight:700">HistÃ³rico de NÃ­vel</div><div class="muted">Ãšltimas 6 horas</div></div>
          <div class="muted" id="refresh-note">Atualiza a cada 5s</div>
        </div>
        <div style="margin-top:12px"><canvas id="levelChart" height="160"></canvas></div>
      </section>

      <!-- Alerts -->
      <aside class="col-4 card">
        <div style="font-weight:700">Alertas</div>
        <div id="alerts-list" style="margin-top:8px"><div class="muted">Nenhum alerta.</div></div>
      </aside>

      <!-- Device info -->
      <section class="col-8 card">
        <div style="font-weight:700">InformaÃ§Ãµes do dispositivo</div>
        <div style="margin-top:8px" class="muted">Dispositivo: <span id="device-name">â€”</span></div>
        <div class="muted">Heap: <span id="heap">â€”</span></div>
        <div class="muted">RSSI: <span id="rssi">â€”</span></div>
      </section>

      <!-- Telegram / System events -->
      <div class="col-12 card">
        <div style="font-weight:700">Eventos do Sistema (Telegram / Backend)</div>
        <div id="telegram-events">Aguardando eventos...</div>
      </div>

      <!-- Logs -->
      <div class="col-12 card">
        <div style="font-weight:700">Logs recentes</div>
        <div class="muted" id="logs">Nenhum evento recente.</div>
      </div>
    </main>

    <footer>Â© AcquaSys â€” Monitoramento em tempo real.</footer>
  </div>

  <!-- Backend URL -->
  <script>window.API_URL = "https://acquasys-backend.onrender.com";</script>

  <script>
    const API = window.API_URL || location.origin;

    const endpoints = {
      latest: `${API}/api/mqtt/sensor-data/latest`,
      history: `${API}/api/mqtt/sensor-data/history?hours=6`
    };

    const el = {
      level: document.getElementById("water-level"),
      levelBar: document.getElementById("level-bar"),
      last: document.getElementById("last-update"),
      pump: document.getElementById("pump-chip"),
      current: document.getElementById("current"),
      temp: document.getElementById("temp"),
      flow: document.getElementById("flow"),
      eff: document.getElementById("eff"),
      device: document.getElementById("device-name"),
      heap: document.getElementById("heap"),
      rssi: document.getElementById("rssi"),
      alerts: document.getElementById("alerts-list"),
      events: document.getElementById("telegram-events"),
      logs: document.getElementById("logs")
    };

    const chart = new Chart(document.getElementById("levelChart"), {
      type:"line",
      data:{labels:[],datasets:[{label:"NÃ­vel (%)",data:[],borderColor:"#0078D4",tension:0.3,pointRadius:0}]},
      options:{responsive:true,scales:{y:{min:0,max:100}}}
    });

    function pushEvent(msg){
      const t = new Date().toLocaleTimeString();
      el.events.textContent = `${t} â€” ${msg}\n` + el.events.textContent;
    }

    function pushLog(msg){
      const t = new Date().toLocaleTimeString();
      el.logs.textContent = `${t} â€” ${msg}\n` + el.logs.textContent;
    }

    function applyData(d){
      if(!d) return;
      el.level.textContent = `${d.level.toFixed(1)}%`;
      el.levelBar.style.width = `${d.level}%`;
      el.pump.textContent = d.pump ? "LIGADA" : "DESLIGADA";
      el.pump.className = `chip ${d.pump ? "on" : "off"}`;
      el.current.textContent = `${d.current.toFixed(2)} A`;
      el.temp.textContent = `${d.temperature.toFixed(1)} Â°C`;
      el.eff.textContent = `${d.efficiency?.toFixed(1) || 100}%`;
      el.device.textContent = d.device || "â€”";
      el.heap.textContent = d.heap ? `${Math.round(d.heap/1024)} KB` : "â€”";
      el.rssi.textContent = `${d.rssi ?? "â€”"} dBm`;
    }

    async function fetchLatest(){
      try{
        const res = await fetch(endpoints.latest);
        const json = await res.json();
        applyData(json.mqtt || json);
      }catch(e){ pushLog("Erro ao buscar latest: "+e.message); }
    }

    async function fetchHistory(){
      try{
        const res = await fetch(endpoints.history);
        const hist = await res.json();
        const pts = hist.map(r=>({t:new Date(r.timestamp||r._time),y:r.level}));
        chart.data.labels = pts.map(p=>p.t.toLocaleTimeString());
        chart.data.datasets[0].data = pts.map(p=>p.y);
        chart.update();
      }catch(e){ pushLog("Erro ao buscar histÃ³rico: "+e.message); }
    }

    function openWs(){
      const wsUrl = API.replace(/^http/, "ws") + "/ws";
      const ws = new WebSocket(wsUrl);
      ws.onopen = ()=>pushEvent("Conectado ao servidor WebSocket");
      ws.onmessage = evt=>{
        try{
          const msg = JSON.parse(evt.data);
          if(msg.type==="sensorData") applyData(msg.data);
          if(msg.type==="telegramLog") pushEvent(msg.data.message);
          if(msg.type==="systemAlert") pushEvent("ðŸš¨ "+msg.data.message);
        }catch{}
      };
      ws.onclose = ()=>setTimeout(openWs, 5000);
      ws.onerror = ()=>ws.close();
    }

    (async function init(){
      await fetchHistory();
      await fetchLatest();
      openWs();
      setInterval(fetchLatest, 5000);
    })();
  </script>
</body>
</html>
