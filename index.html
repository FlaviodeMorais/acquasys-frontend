<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AcquaSys</title>
  <meta name="description" content="AcquaSys · Dashboard de monitoramento" />
  <meta name="theme-color" content="#0078D4" />
  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --muted:#6b7280;
      --brand:#0078D4;
      --accent:#0ea5e9;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:#0f172a}
    .container{max-width:1200px;margin:28px auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    .brand{
      display:flex;align-items:center;gap:12px;
    }
    .logo{
      width:52px;height:52px;border-radius:8px;
      background:linear-gradient(135deg,var(--brand),#004a8a);
      display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:20px;
    }
    h1{margin:0;font-size:20px}
    p.subtitle{margin:0;color:var(--muted);font-size:13px}
    .status{display:flex;gap:14px;align-items:center;color:var(--muted);font-size:13px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{background:var(--card);border-radius:10px;padding:16px;box-shadow:0 6px 18px rgba(10,20,40,0.04)}
    .col-4{grid-column:span 4}
    .col-8{grid-column:span 8}
    .col-12{grid-column:span 12}
    .metric-large{font-size:36px;font-weight:700;color:var(--brand)}
    .muted{color:var(--muted);font-size:13px}
    .bar{height:10px;background:#eef2f6;border-radius:999px;overflow:hidden;margin-top:10px}
    .bar-fill{height:100%;background:linear-gradient(90deg,#10b981,#0078D4);width:40%}
    .chip{display:inline-flex;padding:6px 10px;border-radius:999px;font-size:13px}
    .chip.on{background:#ecfeff;color:#0369a1}
    .chip.off{background:#fff7ed;color:#9a3412}
    .small-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
    .alert{padding:10px;border-radius:8px;background:#fff3f2;color:#9b1c1c;border:1px solid #ffd7d2}
    footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}
    @media (max-width:900px){
      .col-4,.col-8{grid-column:span 12}
      .small-grid{grid-template-columns:repeat(1,1fr)}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">A</div>
        <div>
          <h1>AcquaSys</h1>
          <p class="subtitle">Monitoramento IoT · Nível e Controle de Bombas</p>
        </div>
      </div>

      <div class="status" id="status-strip">
        <div>MQTT: <strong id="stat-mqtt" style="color:#ef4444">offline</strong></div>
        <div>InfluxDB: <strong id="stat-influx" style="color:#ef4444">offline</strong></div>
      </div>
    </header>

    <main class="grid">
      <!-- Left column: metrics -->
      <section class="card col-4">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="muted">Nível do Reservatório</div>
            <div class="metric-large" id="water-level">--%</div>
            <div class="muted" id="last-update">Última: —</div>
          </div>
          <div style="text-align:right">
            <div class="muted">Bomba</div>
            <div id="pump-chip" class="chip off">DESLIGADA</div>
            <div style="height:12px"></div>
            <div class="muted">Corrente</div>
            <div style="font-weight:600;font-size:18px" id="current">-- A</div>
          </div>
        </div>

        <div class="bar" aria-hidden="true">
          <div class="bar-fill" id="level-bar" style="width:0%"></div>
        </div>

        <div class="small-grid">
          <div class="card" style="padding:12px">
            <div class="muted">Temperatura</div>
            <div style="font-weight:700;font-size:18px" id="temp">-- °C</div>
          </div>
          <div class="card" style="padding:12px">
            <div class="muted">Vazão</div>
            <div style="font-weight:700;font-size:18px" id="flow">-- L/m</div>
          </div>
          <div class="card" style="padding:12px">
            <div class="muted">Eficiência</div>
            <div style="font-weight:700;font-size:18px" id="eff">-- %</div>
          </div>
        </div>
      </section>

      <!-- Right column: chart -->
      <section class="card col-8">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:700">Histórico de Nível</div>
            <div class="muted">Últimas 6 horas</div>
          </div>
          <div class="muted" id="refresh-note">Atualiza a cada 5s</div>
        </div>

        <div style="margin-top:12px">
          <canvas id="levelChart" height="160"></canvas>
        </div>
      </section>

      <!-- Alerts & info -->
      <aside class="col-4 card">
        <div style="font-weight:700">Alertas</div>
        <div id="alerts-list" style="margin-top:8px">
          <div class="muted">Nenhum alerta.</div>
        </div>
      </aside>

      <section class="col-8 card">
        <div style="font-weight:700">Informações do dispositivo</div>
        <div style="margin-top:8px" class="muted">Dispositivo: <span id="device-name">—</span></div>
        <div class="muted">Heap: <span id="heap">—</span></div>
        <div class="muted">RSSI: <span id="rssi">—</span></div>
      </section>

      <div class="col-12">
        <div class="card">
          <div style="font-weight:700">Logs recentes</div>
          <div class="muted" id="logs">Nenhum evento recente.</div>
        </div>
      </div>
    </main>

    <footer>
      © AcquaSys — Dashboard · Conecte ao backend e veja atualizações em tempo real.
    </footer>
  </div>

  <script>
    /* CONFIGURATION:
       - Se usar Vite: defina VITE_API_URL em import.meta.env; aqui lemos window.API_URL ou processEnv global.
       - By default tenta usar same-origin /api; melhor: set window.API_URL = 'https://acquasys-backend.onrender.com' antes de incluir o HTML.
    */
    const API = (function(){
      if (typeof VITE_API_URL !== 'undefined') return VITE_API_URL;
      if (typeof window?.API_URL === 'string') return window.API_URL;
      // fallback to same origin
      return '';
    })();

    const endpoints = {
      latest: (api)=> (api? `${api}/api/mqtt/sensor-data/latest` : '/api/mqtt/sensor-data/latest'),
      history: (api)=> (api? `${api}/api/mqtt/sensor-data/history?hours=6` : '/api/mqtt/sensor-data/history?hours=6'),
      status: (api)=> (api? `${api}/api/mqtt/status` : '/api/mqtt/status')
    };

    // DOM refs
    const el = {
      level: document.getElementById('water-level'),
      last: document.getElementById('last-update'),
      levelBar: document.getElementById('level-bar'),
      pumpChip: document.getElementById('pump-chip'),
      current: document.getElementById('current'),
      temp: document.getElementById('temp'),
      flow: document.getElementById('flow'),
      eff: document.getElementById('eff'),
      alerts: document.getElementById('alerts-list'),
      device: document.getElementById('device-name'),
      heap: document.getElementById('heap'),
      rssi: document.getElementById('rssi'),
      logs: document.getElementById('logs'),
      statMqtt: document.getElementById('stat-mqtt'),
      statInflux: document.getElementById('stat-influx')
    };

    // Chart.js setup
    const ctx = document.getElementById('levelChart').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'line',
      data: { labels: [], datasets: [{ label: 'Nível (%)', data: [], fill:false, borderColor:'#0078D4', tension:0.3, pointRadius:0 }] },
      options: {
        responsive:true,
        maintainAspectRatio:false,
        scales:{
          y:{min:0,max:100,ticks:{stepSize:10}},
          x:{display:true}
        },
        plugins:{legend:{display:false},tooltip:{mode:'index',intersect:false}}
      }
    });

    // Utilities
    function setStatus(elm, ok){ elm.textContent = ok ? 'online' : 'offline'; elm.style.color = ok ? '#16a34a' : '#ef4444'; }
    function pushLog(msg){ const t = new Date().toLocaleTimeString(); el.logs.textContent = `${t} — ${msg}\n` + el.logs.textContent; }

    // Update UI from latest object
    function applyLatest(data){
      if(!data) return;
      const lvl = Number(data.level ?? data.waterLevel ?? 0);
      el.level.textContent = `${lvl.toFixed(1)}%`;
      el.levelBar.style.width = Math.max(0,Math.min(100,lvl)) + '%';
      el.last.textContent = 'Última: ' + (new Date(data.timestamp || Date.now())).toLocaleString();
      el.pumpChip.textContent = (data.pump ? 'LIGADA' : 'DESLIGADA');
      el.pumpChip.className = 'chip ' + (data.pump ? 'on' : 'off');
      el.current.textContent = `${(data.current ?? 0).toFixed(2)} A`;
      el.temp.textContent = `${(data.temperature ?? 0).toFixed(1)} °C`;
      el.flow.textContent = `${(data.flowRate ?? 0).toFixed(1)} L/m`;
      el.eff.textContent = `${(data.efficiency ?? 0).toFixed(1)} %`;
      el.device.textContent = data.device ?? '—';
      el.heap.textContent = data.heap ? `${Math.round(data.heap/1024)} KB` : '—';
      el.rssi.textContent = (data.rssi ?? '—') + ' dBm';
      pushLog(`Dados mais recentes recebidos (nível ${lvl.toFixed(1)}%)`);
      // alerts
      const alertList = [];
      if (lvl < 12) alertList.push(`Nível crítico: ${lvl.toFixed(1)}%`);
      if ((data.current ?? 0) > 4.5) alertList.push(`Corrente elevada: ${(data.current ?? 0).toFixed(2)} A`);
      if ((data.efficiency ?? 100) < 50) alertList.push(`Eficiência baixa: ${(data.efficiency ?? 0).toFixed(1)}%`);
      renderAlerts(alertList);
    }

    function renderAlerts(list){
      if(!list || list.length===0){
        el.alerts.innerHTML = '<div class="muted">Nenhum alerta.</div>';
        return;
      }
      el.alerts.innerHTML = '';
      for(const a of list){
        const d = document.createElement('div'); d.className='alert'; d.textContent=a;
        el.alerts.appendChild(d);
      }
    }

    // fetch latest, apply and return boolean success
    async function fetchLatest(){
      try{
        const res = await fetch(endpoints.latest(API));
        if(!res.ok) throw new Error('no-latest');
        const data = await res.json();
        applyLatest(data);
        setStatus(el.statMqtt,true);
        return true;
      }catch(e){
        setStatus(el.statMqtt,false);
        pushLog('Falha ao buscar latest: ' + (e.message || e));
        return false;
      }
    }

    // fetch history and populate chart
    async function fetchHistory(){
      try{
        const res = await fetch(endpoints.history(API));
        if(!res.ok) throw new Error('no-history');
        const hist = await res.json();
        // normalize to points
        const points = (Array.isArray(hist) ? hist : []).map(r => {
          const t = new Date(r.timestamp || r._time || Date.now());
          return { time: t.toLocaleTimeString(), level: (r.level ?? r.waterLevel ?? 0) };
        }).slice(-96);
        chart.data.labels = points.map(p=>p.time);
        chart.data.datasets[0].data = points.map(p=>p.level);
        chart.update();
        setStatus(el.statInflux,true);
        pushLog('Histórico atualizado ('+points.length+' pontos)');
        return true;
      }catch(e){
        setStatus(el.statInflux,false);
        pushLog('Falha ao buscar histórico: ' + (e.message || e));
        return false;
      }
    }

    // Polling + websocket
    let pollHandle = null;
    async function startPolling(){
      await fetchHistory();
      await fetchLatest();
      if(pollHandle) clearInterval(pollHandle);
      pollHandle = setInterval(fetchLatest, 5000);
    }

    function openWs(){
      try{
        const wsUrl = (function(){
          const base = API || (location.origin);
          // prefer ws at same host: /ws
          return (base.startsWith('http') ? base.replace(/^http/, 'ws') : '') + '/ws';
        })();
        if(!wsUrl) return;
        const ws = new WebSocket(wsUrl);
        ws.onopen = ()=>{ pushLog('WebSocket conectado'); setStatus(el.statMqtt,true); };
        ws.onmessage = (evt)=> {
          try{
            const msg = JSON.parse(evt.data);
            if(msg.type === 'sensorData' || msg.type === 'data-update'){
              const d = msg.data || msg.sensorData || msg;
              applyLatest(d);
            }
          }catch(e){}
        };
        ws.onclose = ()=>{ pushLog('WebSocket desconectado (fallback para polling)'); setStatus(el.statMqtt,false); setTimeout(openWs,10000); };
        ws.onerror = ()=>{ setStatus(el.statMqtt,false); ws.close(); };
      }catch(e){}
    }

    // Inicialização
    (async function init(){
      // Try fetches
      await startPolling();
      // Try WebSocket (non-critical)
      openWs();
    })();

    // expose for debugging
    window.acquasys = { fetchLatest, fetchHistory, chart };
  </script>
</body>
</html>

